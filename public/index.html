<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>LOEW Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        color-scheme: dark;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #020617;
        color: #e5e7eb;
      }

      /* ===== LAYOUT ===== */

      .app {
        min-height: 100vh;
        display: flex;
        align-items: stretch;
        justify-content: center;
        padding: 8px;
      }

      .chat-shell {
        width: 100%;
        max-width: 760px;
        margin: auto;
        background: radial-gradient(circle at top, #020617, #020617 40%, #000);
        border-radius: 18px;
        border: 1px solid #1f2937;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      @media (max-width: 640px) {
        .app {
          padding: 0;
        }

        .chat-shell {
          border-radius: 0;
          max-width: 100%;
          border-left: none;
          border-right: none;
          box-shadow: none;
        }
      }

      /* ===== HEADER ===== */

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        border-bottom: 1px solid #1f2937;
        gap: 10px;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-circle {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #22c55e, #0f766e);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: 700;
        color: #ecfdf5;
        flex-shrink: 0;
      }

      .title-block {
        display: flex;
        flex-direction: column;
      }

      .title {
        font-size: 15px;
        font-weight: 600;
      }

      .subtitle {
        font-size: 11px;
        opacity: 0.7;
      }

      .header-right {
        font-size: 11px;
        text-align: left;
        display: flex;
        flex-direction: column;
        gap: 3px;
        align-items: flex-start;
      }

      /* ===== CHAT BODY ===== */

      .chat-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 10px 14px 74px;
        max-height: calc(100vh - 120px);
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .message-row {
        display: flex;
        gap: 8px;
        width: 100%;
      }

      .message-row.assistant {
        flex-direction: row;
      }

      .message-row.user {
        flex-direction: row-reverse;
      }

      .avatar {
        width: 26px;
        height: 26px;
        border-radius: 999px;
        background: #111827;
        border: 1px solid #1f2937;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        flex-shrink: 0;
      }

      .avatar.assistant {
        background: radial-gradient(circle at 30% 30%, #22c55e, #0f766e);
        color: #ecfdf5;
        border: none;
      }

      .avatar.user {
        background: #1f2937;
        color: #e5e7eb;
      }

      .bubble {
        max-width: 80%;
        padding: 7px 10px;
        border-radius: 14px;
        font-size: 14px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .bubble.assistant {
        background: #020617;
        border: 1px solid #1f2937;
      }

      .bubble.user {
        background: #10b981;
        color: #022c22;
      }

      @media (max-width: 640px) {
        .chat-body {
          padding: 10px 10px 70px;
          max-height: calc(100vh - 100px);
        }

        .bubble {
          max-width: 88%;
          font-size: 13px;
        }
      }

      /* ===== INPUT BAR ===== */

      .input-wrap {
        position: sticky;
        bottom: 0;
        padding: 6px 10px 10px;
        background: linear-gradient(
          to top,
          rgba(2, 6, 23, 0.98),
          rgba(2, 6, 23, 0.92),
          rgba(2, 6, 23, 0.7),
          transparent
        );
      }

      .input-row {
        display: flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        border: 1px solid #374151;
        background: #020617;
        padding: 4px 4px 4px 8px;
      }

      .input-row input {
        flex: 1;
        border: none;
        outline: none;
        background: transparent;
        color: #e5e7eb;
        font-size: 14px;
        padding: 6px 4px;
      }

      .input-row input::placeholder {
        color: #6b7280;
      }

      .send-btn {
        border-radius: 999px;
        border: none;
        padding: 7px 14px;
        background: #22c55e;
        color: #022c22;
        font-weight: 600;
        cursor: pointer;
        font-size: 13px;
        flex-shrink: 0;
      }

      .send-btn:disabled {
        opacity: 0.6;
        cursor: default;
      }

      .small-note {
        font-size: 10px;
        opacity: 0.6;
        margin-top: 4px;
        text-align: center;
      }

      @media (max-width: 640px) {
        .input-wrap {
          padding: 6px 8px 9px;
        }

        .send-btn {
          padding: 6px 11px;
          font-size: 12px;
        }

        .input-row input {
          font-size: 13px;
        }
      }
    </style>
  </head>

  <body>
    <div class="app">
      <div class="chat-shell">
        <!-- HEADER -->
        <header class="header">
          <div class="header-left">
            <div class="logo-circle">L</div>
            <div class="title-block">
              <div class="title">LOEW – המאמן האישי שלך</div>
              <div class="subtitle">
                צ'אט אימון חכם שמתאים את עצמו לרוכב שמולו.
              </div>
            </div>
          </div>
          <div class="header-right">
            <div>
              רוכב נוכחי:
              <strong id="user-id-label"></strong>
            </div>
          </div>
        </header>

        <!-- BODY -->
        <main class="chat-body">
          <div id="messages" class="messages"></div>
        </main>

        <!-- INPUT -->
        <div class="input-wrap">
          <div class="input-row">
            <input
              id="input"
              type="text"
              placeholder="תכתוב משהו ל-LOEW (למשל: מה האימון שלי היום?)"
            />
            <button id="send-btn" class="send-btn">שלח</button>
          </div>
          <div class="small-note">
            אפשר להשתמש באותו לינק לכמה רוכבים – לכל אחד פשוט userId אחר
            בכתובת.
          </div>
        </div>
      </div>
    </div>

    <script>
  // ===== USER ID LOGIC =====
  function getUserIdFromUrlOrStorage() {
    const params = new URLSearchParams(window.location.search);
    let id = params.get("userId");

    if (id && id.trim()) {
      id = id.trim();
      localStorage.setItem("loew_user_id", id);
      return id;
    }

    const stored = localStorage.getItem("loew_user_id");
    if (stored && stored.trim()) {
      return stored.trim();
    }

    const fallback = "roy";
    localStorage.setItem("loew_user_id", fallback);
    return fallback;
  }

  const USER_ID = getUserIdFromUrlOrStorage();

  const messagesEl = document.getElementById("messages");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("send-btn");
  const userIdLabel = document.getElementById("user-id-label");
  userIdLabel.textContent = USER_ID;

  let hasStrava = false;

  function addMessage(text, who) {
    const row = document.createElement("div");
    row.className = "message-row " + (who === "user" ? "user" : "assistant");

    const avatar = document.createElement("div");
    avatar.className =
      "avatar " + (who === "user" ? "user" : "assistant");
    avatar.textContent = who === "user" ? "אני" : "L";

    const bubble = document.createElement("div");
    bubble.className =
      "bubble " + (who === "user" ? "user" : "assistant");
    bubble.textContent = text;

    row.appendChild(avatar);
    row.appendChild(bubble);
    messagesEl.appendChild(row);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // הודעה שמכילה לינק (HTML)
  function addHtmlMessage(html, who) {
    const row = document.createElement("div");
    row.className = "message-row " + (who === "user" ? "user" : "assistant");

    const avatar = document.createElement("div");
    avatar.className =
      "avatar " + (who === "user" ? "user" : "assistant");
    avatar.textContent = who === "user" ? "אני" : "L";

    const bubble = document.createElement("div");
    bubble.className =
      "bubble " + (who === "user" ? "user" : "assistant");
    bubble.innerHTML = html;

    row.appendChild(avatar);
    row.appendChild(bubble);
    messagesEl.appendChild(row);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  async function fetchSnapshotOnce() {
    try {
      const res = await fetch("/api/loew/strava-snapshot", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: USER_ID }),
      });
      const data = await res.json();
      hasStrava = !!data.ok;
    } catch (err) {
      console.warn("snapshot init error", err);
      hasStrava = false;
    }
  }

  async function fetchSnapshot() {
    try {
      const res = await fetch("/api/loew/strava-snapshot", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: USER_ID }),
      });
      const data = await res.json();
      if (data.ok) {
        hasStrava = true;
        return data.snapshot;
      }
    } catch (err) {
      console.warn("snapshot error", err);
    }
    return null;
  }

  async function callChatAPI(text, snapshot) {
    const res = await fetch("/api/loew/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: USER_ID,
        message: text,
        snapshot: snapshot,
      }),
    });
    return res.json();
  }

  async function sendMessage() {
    const text = inputEl.value.trim();
    if (!text) return;

    addMessage(text, "user");
    inputEl.value = "";
    inputEl.focus();
    sendBtn.disabled = true;

    // אם אין סטרבה וכל מה שנכתב זה "כן" → ננסה גם רידיירקט אוטומטי
    const normalized = text.trim().toLowerCase().replace(/[.!?…]/g, "");
    if (!hasStrava && (normalized === "כן" || normalized === "yes" || normalized === "y")) {
      const url =
        "https://loew.onrender.com/auth/strava?userId=" +
        encodeURIComponent(USER_ID);
      window.location.href = url;
      // אם משום מה הדפדפן לא עושה redirect, נשחרר את הכפתור
      setTimeout(() => {
        sendBtn.disabled = false;
      }, 1500);
      return;
    }

    let snapshot = await fetchSnapshot();

    try {
      const data = await callChatAPI(text, snapshot);

      if (!data.ok && data.error) {
        addMessage("שגיאה מהשרת: " + data.error, "assistant");
        return;
      }

      if (data.reply) {
        addMessage(data.reply, "assistant");
      } else {
        addMessage("לא קיבלתי תשובה מ-LOEW.", "assistant");
      }
    } catch (err) {
      console.error(err);
      addMessage("הייתה תקלה בתקשורת עם השרת.", "assistant");
    } finally {
      sendBtn.disabled = false;
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendMessage();
    }
  });

  // ===== INIT =====
  (async function init() {
    await fetchSnapshotOnce();

    if (!hasStrava) {
      addMessage(
        "היי, אני LOEW.\n" +
          "אני רואה שעוד לא חיברת חשבון Strava.\n" +
          "יש לך סטרבה שתרצה לחבר? תכתוב 'כן' כדי להתחבר, או 'לא' אם תרצה להמשיך בלי.",
        "assistant"
      );

      const stravaUrl =
        "https://loew.onrender.com/auth/strava?userId=" +
        encodeURIComponent(USER_ID);

      addHtmlMessage(
        "או שפשוט <a href=\"" +
          stravaUrl +
          "\" style=\"color:#22c55e; text-decoration:underline;\">לחץ כאן להתחברות לסטרבה</a>.",
        "assistant"
      );
    } else {
      addMessage(
        "היי, אני LOEW.\n" +
          "יש לי נתונים מסטרבה עבורך. אתה יכול לשאול על האימון האחרון, לבקש תוכנית אימונים, או כל דבר אחר.",
        "assistant"
      );
    }
  })();
</script>

  </body>
</html>
